---
title: "Mapping specificity, entropy, allosteric changes and substrates in blood coagulation proteases by a high-throughput protease screen"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load all required functions, packages and a ggplot theme for plotting
```{r, echo=FALSE}
source("HTPS_functions.R")
require(seqinr)
require(ggplot2)
require(pheatmap)
require(reshape2)
require(ggsci)

theme_Publication<-function(base_size=9, base_family='sans') {
  library(grid)
  library(ggthemes)
  (theme_foundation(base_family=base_family)
    + theme(plot.title = element_text(face = "plain",
                                      size = rel(1.2), hjust = 0.5),
            text = element_text(),
            panel.background = element_rect(colour = NA),
            plot.background = element_rect(colour = NA),
            axis.title = element_text(face = "plain",size = 9),
            axis.title.y = element_text(angle=90,vjust =2),
            axis.title.x = element_text(vjust = -0.2),
            axis.text = element_text(size=6), 
            axis.line.x = element_line(colour="black"),
            axis.line.y = element_line(colour="black"),
            axis.ticks = element_line(),
            panel.grid.major = element_line(colour="#f0f0f0"),
            panel.grid.minor = element_blank(),
            legend.key = element_rect(colour = NA),
            legend.position = "bottom",
            legend.direction = "horizontal",
            legend.key.size= unit(0.2, "cm"),
            legend.spacing = unit(0, "cm"),
            plot.margin=unit(c(10,5,5,5),"mm"),
            strip.background=element_rect(colour="#f0f0f0",fill="#f0f0f0"),
            strip.text = element_text(face="plain"),
            legend.text=element_text(size=7),
            legend.title=element_blank(),
            panel.border = element_rect(colour = "black", fill=NA, size=.5)
    ))
  
}

rmback<-
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank()) +
  theme(strip.background =element_rect(fill="white"))



```


## Prepare data for analysis and generate cleavage file
Here the file peptides.txt derived from a maxQuant search can be loaded. In the provided txt file we benchmarked HTPS to characterize trypsin specificity, entropy and block entropy. 
C terminal and N terminal cleavage sequences are combined and filtered to obtain a list representing unique cleavage windows.  
To provide supplementary plots on identified peptide such as MQ SCORE and PEP set debugs_plot=TRUE. 

```{r}


input<-preparing_input("peptides.txt", debugs_plot=FALSE) 


input_1<-split_cleavage(input, 'Intensity.1', debugs_plot=FALSE)
input_2<-split_cleavage(input, 'Intensity.2', debugs_plot=FALSE)
input_3<-split_cleavage(input, 'Intensity.3', debugs_plot=FALSE)



unique<-data.frame(rbind(input_1,input_2, input_3))
unique<-data.frame(unique(unique)) 
# identified 4260 unique cleavages

# write cleavages file
cleavages <- cbind.fill(input_1, input_2, input_3)
# change location output file
write.csv(cleavages, "cleavages.csv")
cleavages<-data.frame(cleavages)
```


## Load HTPS_db.fasta file
```{r}
HTPS_DB<-read.fasta("HTPS_db.fasta", seqtype = c("AA"), strip.desc = TRUE, seqonly = TRUE)
HTPS_DB<-data.frame(HTPS_DB)
HTPS_DB<-sapply(HTPS_DB, as.character)
```

## Retrieve specificity and entropy information for the studied protease and for a control.
A frequency matrix for the studied protease is generated from the frequency position of amino acids in the cleavage windows.
For control, a random frequency matrix is generated by sampling the same number of amino acids as contained in the frequency matrix from the natural distribution of amino acids in HTPS_DB.fasta

```{r}
cleavages<-start_fun(cleavages, 'aa_freq.csv')

cleavages_1 <- cleavages[[1]][!is.na(cleavages[[1]])]
cleavages_2 <- cleavages[[2]][!is.na(cleavages[[2]])]
cleavages_3 <- cleavages[[3]][!is.na(cleavages[[3]])]

comb1<-specificity_entropy_tda(cleavages_1, HTPS_DB)
comb2<-specificity_entropy_tda(cleavages_2, HTPS_DB)
comb3<-specificity_entropy_tda(cleavages_3, HTPS_DB)

```

# Plot and Output table
## Protease specificity

```{r}
speci_combi<-cbind(comb1[['targ_spec']], comb2[['targ_spec']], comb3[['targ_spec']], 
                   comb1[['dec_spec']], comb2[['dec_spec']], comb3[['dec_spec']])
speci_combi<-data.frame(cbind(speci_combi$ID, log2(speci_combi[,c(3,7,11,15,19,23)])))
colnames(speci_combi)[1]<-c("ID")
specificity<-calc_stats(speci_combi)
colnames(specificity)<-c("ID","specificity_1", "specificity_2", "specificity_3",
                         "specificity_CTRL_1", "specificity_CTRL_2", "specificity_CTRL_3", 
                         "median_specificity", "median_CTRL_specificity", "FC", "pval",
                         "p_val_adj","FC_sign","FC_sign_pos")
specificity$ID<-gsub('X', '', specificity$ID)
write.csv(specificity, "specificity.csv")

pos<-c("P8","P7","P6","P5", "P4", "P3","P2", "P1", 
             "P1'","P2'","P3'","P4'","P5'","P6'","P7'","P8'")

tmp0<-specificity[,c(1,14)]
tmp0character<-as.character(tmp0[,1])
tmp0character<-data.frame((strsplit(tmp0character, "_")))
tmp0character<-data.frame(t(tmp0character))
tmp0<-data.frame(cbind(tmp0character, tmp0[,2]))
colnames(tmp0)<-c("AA", "pos", "FC")
# plot
m<-dcast(tmp0, AA~pos)
rownames(m)<-m$AA
m<-m[,c(2,10:17,3:9)]
colnames(m)<-pos

bk <- c(seq(0,2, length=100))
my_palette <-colorRampPalette(c('grey100','red')) (n=201)

# plot specificity
# change location output folder
pheatmap<-pheatmap(m, cluster_rows = F, cluster_cols = F, 
                   breaks =bk, color =my_palette,
                   cellheight=12, cellwidth=12,
                   legend=T,
                   main = "Specificity", fontsize =7)
```


## Protease entropy

```{r}
entropy<-cbind(comb1[['targ_entr']], comb2[['targ_entr']], comb3[['targ_entr']], 
               comb1[['dec_entr']], comb2[['dec_entr']], comb3[['dec_entr']])
entropy_1<-data.frame(applyBy(entropy, 3, apply, 1, median))
entropy<-cbind(entropy, entropy_1)
entropy$FC<-entropy$X1-entropy$X2
colnames(entropy)<-c("entropy_1", "entropy_2", "entropy_3",
                     "entropy_CTRL_1", "entropy_CTRL_2", "entropy_CTRL_3", 
                     "median_entropy", "median_CTRL_entropy", "FC")
entropy$ID<-rownames(entropy)
entropy<-entropy[,c(10,1:9)]
entropy$ID<-gsub('X', '', entropy$ID)
write.csv(entropy, "entropy.csv")
tmp20<-data.frame(cbind(entropy$median_entropy, entropy$median_CTRL_entropy))
colnames(tmp20)<-c("Sample", "CTRL")
tmp20<-data.frame(tmp20)

tmp20$pos<-pos
tmp21<-melt(tmp20, id=c("pos"))
i<- ggplot(tmp21, aes(x=pos,y= value, group = variable))
i<-i+geom_line(aes(color=variable), size =1.5)
i<-i+geom_point(aes(shape=variable), size =3)
i<-i+scale_color_npg() + scale_x_discrete(name = "Position", 
                                          limits = pos)
i<-i+xlab('Position')+ylab('Entropy per Position (S)')
i<-i+theme_Publication()+rmback
i<-i+geom_hline(yintercept = 0.9, linetype = "dashed", color = "grey30")
i<-i+ylim(0.2,1.05)
plot(i)
```



# Protease block entropy

```{r}
block_entropy<-block_entropy_function(entropy, debugs_plot=FALSE)
write.csv(block_entropy, "blockentropy.csv")
tmp5<-data.frame(t(block_entropy[,1:8]))

tmp30<-data.frame(tmp5$protease,tmp5$ctrl)

colnames(tmp30)<-c("Sample", "CTRL")
tmp30$pos<-c("B4","B3","B2","B1","B1'","B2'","B3'","B4'")

tmp31<-melt(tmp30, id=c("pos"))
# plot block entropy

i<- ggplot(tmp31, aes(x=pos,y= value, group = variable))
i<-i+geom_line(aes(color=variable), size =1.5)
i<-i+geom_point(aes(shape=variable, alpha=0.5), size =3)
i<-i + scale_x_discrete(name = "Position", limits =c ("B4","B3","B2","B1",
                                                      "B1'","B2'","B3'","B4'"))
i<-i+scale_color_npg()
i<-i+xlab('Position')+ylab('Block ntropy per Position (S)')
i<-i+theme_Publication()+rmback
plot(i)

```

